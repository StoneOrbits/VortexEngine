\hypertarget{classStorage}{}\doxysection{Storage Class Reference}
\label{classStorage}\index{Storage@{Storage}}


{\ttfamily \#include $<$Storage.\+h$>$}

\doxysubsection*{Static Public Member Functions}
\begin{DoxyCompactItemize}
\item 
static bool \mbox{\hyperlink{classStorage_a065812a8dbd82d731291b5aa7ce3edf9}{init}} ()
\item 
static void \mbox{\hyperlink{classStorage_a2a1ce108c9a17f6175bfb9a9aba51703}{cleanup}} ()
\item 
static bool \mbox{\hyperlink{classStorage_acbeeb0de638cf1a1861759150721c0b7}{write}} (uint8\+\_\+t slot, \mbox{\hyperlink{classByteStream}{Byte\+Stream}} \&buffer)
\item 
static bool \mbox{\hyperlink{classStorage_a7c0c5463f59c7028bdcf812fb928ffcd}{read}} (uint8\+\_\+t slot, \mbox{\hyperlink{classByteStream}{Byte\+Stream}} \&buffer)
\item 
static uint32\+\_\+t \mbox{\hyperlink{classStorage_a79176e030af1f92f563c2b19316fe3dd}{last\+Save\+Size}} ()
\end{DoxyCompactItemize}
\doxysubsection*{Private Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classStorage_a80ef6af5e4c9fd4424ae16e808d05291}{Storage}} ()
\end{DoxyCompactItemize}
\doxysubsection*{Static Private Member Functions}
\begin{DoxyCompactItemize}
\item 
static void \mbox{\hyperlink{classStorage_a9c873bd223652fa8339840a1b350b931}{eeprom\+Write\+Byte}} (uint16\+\_\+t index, uint8\+\_\+t in)
\item 
static uint8\+\_\+t \mbox{\hyperlink{classStorage_ad564f35a9671864cb0bed1ffa671c63d}{eeprom\+Read\+Byte}} (uint16\+\_\+t index)
\end{DoxyCompactItemize}
\doxysubsection*{Static Private Attributes}
\begin{DoxyCompactItemize}
\item 
static uint32\+\_\+t \mbox{\hyperlink{classStorage_ae85ca521ae89c408fb045d2890951458}{m\+\_\+last\+Save\+Size}} = 0
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


Definition at line 12 of file Storage.\+h.



\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{classStorage_a80ef6af5e4c9fd4424ae16e808d05291}\label{classStorage_a80ef6af5e4c9fd4424ae16e808d05291}} 
\index{Storage@{Storage}!Storage@{Storage}}
\index{Storage@{Storage}!Storage@{Storage}}
\doxysubsubsection{\texorpdfstring{Storage()}{Storage()}}
{\footnotesize\ttfamily Storage\+::\+Storage (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [private]}}



Definition at line 52 of file Storage.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{53 \{}
\DoxyCodeLine{54 \}}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{classStorage_a2a1ce108c9a17f6175bfb9a9aba51703}\label{classStorage_a2a1ce108c9a17f6175bfb9a9aba51703}} 
\index{Storage@{Storage}!cleanup@{cleanup}}
\index{cleanup@{cleanup}!Storage@{Storage}}
\doxysubsubsection{\texorpdfstring{cleanup()}{cleanup()}}
{\footnotesize\ttfamily void Storage\+::cleanup (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 66 of file Storage.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{67 \{}
\DoxyCodeLine{68 \}}

\end{DoxyCode}


Referenced by Vortex\+Engine\+::cleanup().

\mbox{\Hypertarget{classStorage_ad564f35a9671864cb0bed1ffa671c63d}\label{classStorage_ad564f35a9671864cb0bed1ffa671c63d}} 
\index{Storage@{Storage}!eepromReadByte@{eepromReadByte}}
\index{eepromReadByte@{eepromReadByte}!Storage@{Storage}}
\doxysubsubsection{\texorpdfstring{eepromReadByte()}{eepromReadByte()}}
{\footnotesize\ttfamily uint8\+\_\+t Storage\+::eeprom\+Read\+Byte (\begin{DoxyParamCaption}\item[{uint16\+\_\+t}]{index }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}



Definition at line 291 of file Storage.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{292 \{}
\DoxyCodeLine{293   \textcolor{keywordflow}{return} *(\textcolor{keyword}{volatile} uint8\_t *)(MAPPED\_EEPROM\_START + index);}
\DoxyCodeLine{294 \}}

\end{DoxyCode}


Referenced by eeprom\+Write\+Byte().

\mbox{\Hypertarget{classStorage_a9c873bd223652fa8339840a1b350b931}\label{classStorage_a9c873bd223652fa8339840a1b350b931}} 
\index{Storage@{Storage}!eepromWriteByte@{eepromWriteByte}}
\index{eepromWriteByte@{eepromWriteByte}!Storage@{Storage}}
\doxysubsubsection{\texorpdfstring{eepromWriteByte()}{eepromWriteByte()}}
{\footnotesize\ttfamily void Storage\+::eeprom\+Write\+Byte (\begin{DoxyParamCaption}\item[{uint16\+\_\+t}]{index,  }\item[{uint8\+\_\+t}]{in }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}



Definition at line 265 of file Storage.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{266 \{}
\DoxyCodeLine{267   \textcolor{keywordflow}{if} (\mbox{\hyperlink{classStorage_ad564f35a9671864cb0bed1ffa671c63d}{eepromReadByte}}(index) == in) \{}
\DoxyCodeLine{268     \textcolor{keywordflow}{return};}
\DoxyCodeLine{269   \}}
\DoxyCodeLine{270   \textcolor{comment}{// The first two pages of the data goes into the eeprom and then the last page goes}}
\DoxyCodeLine{271   \textcolor{comment}{// into the USERROW which is located at 0x1300}}
\DoxyCodeLine{272   uint16\_t adr = MAPPED\_EEPROM\_START + (index);}
\DoxyCodeLine{273   \_\_asm\_\_ \_\_volatile\_\_(}
\DoxyCodeLine{274     \textcolor{stringliteral}{"{}ldi r30, 0x00"{}}     \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{275     \textcolor{stringliteral}{"{}ldi r31, 0x10"{}}     \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{276     \textcolor{stringliteral}{"{}ldd r18, Z+2"{}}      \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{277     \textcolor{stringliteral}{"{}andi r18, 3"{}}       \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{278     \textcolor{stringliteral}{"{}brne .-\/6"{}}          \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{279     \textcolor{stringliteral}{"{}st X, \%0"{}}          \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{280     \textcolor{stringliteral}{"{}ldi \%0, 0x9D"{}}      \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{281     \textcolor{stringliteral}{"{}out 0x34, \%0"{}}      \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{282     \textcolor{stringliteral}{"{}ldi \%0, 0x03"{}}      \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{283     \textcolor{stringliteral}{"{}st Z, \%0"{}}          \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{284     :\textcolor{stringliteral}{"{}+d"{}}(in)}
\DoxyCodeLine{285     : \textcolor{stringliteral}{"{}x"{}}(adr)}
\DoxyCodeLine{286     : \textcolor{stringliteral}{"{}r30"{}}, \textcolor{stringliteral}{"{}r31"{}}, \textcolor{stringliteral}{"{}r18"{}});}
\DoxyCodeLine{287 }
\DoxyCodeLine{288   \textcolor{keywordflow}{while} (!(NVMCTRL.STATUS \& NVMCTRL\_EEBUSY\_bm));}
\DoxyCodeLine{289 \}}

\end{DoxyCode}


References eeprom\+Read\+Byte().



Referenced by write().

\mbox{\Hypertarget{classStorage_a065812a8dbd82d731291b5aa7ce3edf9}\label{classStorage_a065812a8dbd82d731291b5aa7ce3edf9}} 
\index{Storage@{Storage}!init@{init}}
\index{init@{init}!Storage@{Storage}}
\doxysubsubsection{\texorpdfstring{init()}{init()}}
{\footnotesize\ttfamily bool Storage\+::init (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 56 of file Storage.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{57 \{}
\DoxyCodeLine{58 \textcolor{preprocessor}{\#ifdef VORTEX\_LIB}}
\DoxyCodeLine{59   \textcolor{keywordflow}{if} (!m\_storageFilename.length() \&\& \mbox{\hyperlink{classVortex_aa287fb05ef87acfb1380aeac868d17a1}{Vortex::storageEnabled}}()) \{}
\DoxyCodeLine{60     m\_storageFilename = \mbox{\hyperlink{Storage_8cpp_a3afbe062209d42a72bc5b4a03a86206a}{DEFAULT\_STORAGE\_FILENAME}};}
\DoxyCodeLine{61   \}}
\DoxyCodeLine{62 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{63   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{64 \}}

\end{DoxyCode}


References DEFAULT\+\_\+\+STORAGE\+\_\+\+FILENAME, and Vortex\+::storage\+Enabled().



Referenced by Vortex\+Engine\+::init().

\mbox{\Hypertarget{classStorage_a79176e030af1f92f563c2b19316fe3dd}\label{classStorage_a79176e030af1f92f563c2b19316fe3dd}} 
\index{Storage@{Storage}!lastSaveSize@{lastSaveSize}}
\index{lastSaveSize@{lastSaveSize}!Storage@{Storage}}
\doxysubsubsection{\texorpdfstring{lastSaveSize()}{lastSaveSize()}}
{\footnotesize\ttfamily uint32\+\_\+t Storage\+::last\+Save\+Size (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 258 of file Storage.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{259 \{}
\DoxyCodeLine{260   \textcolor{keywordflow}{return} \mbox{\hyperlink{classStorage_ae85ca521ae89c408fb045d2890951458}{m\_lastSaveSize}};}
\DoxyCodeLine{261 \}}

\end{DoxyCode}


References m\+\_\+last\+Save\+Size.

\mbox{\Hypertarget{classStorage_a7c0c5463f59c7028bdcf812fb928ffcd}\label{classStorage_a7c0c5463f59c7028bdcf812fb928ffcd}} 
\index{Storage@{Storage}!read@{read}}
\index{read@{read}!Storage@{Storage}}
\doxysubsubsection{\texorpdfstring{read()}{read()}}
{\footnotesize\ttfamily bool Storage\+::read (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{slot,  }\item[{\mbox{\hyperlink{classByteStream}{Byte\+Stream}} \&}]{buffer }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 187 of file Storage.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{188 \{}
\DoxyCodeLine{189 \textcolor{preprocessor}{\#ifdef VORTEX\_LIB}}
\DoxyCodeLine{190   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classVortex_aa287fb05ef87acfb1380aeac868d17a1}{Vortex::storageEnabled}}()) \{}
\DoxyCodeLine{191     \textcolor{comment}{// return false here, but true in write because we don't want to return}}
\DoxyCodeLine{192     \textcolor{comment}{// an empty buffer after returning true}}
\DoxyCodeLine{193     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{194   \}}
\DoxyCodeLine{195 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{196   uint32\_t size = \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}};}
\DoxyCodeLine{197   \textcolor{keywordflow}{if} (size > \mbox{\hyperlink{VortexConfig_8h_a8d6f782ffe53d87f0fd0327d4b09352c}{STORAGE\_SIZE}} || size < \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structByteStream_1_1RawBuffer}{ByteStream::RawBuffer}}) + 4 || slot >= \mbox{\hyperlink{VortexConfig_8h_ab0c5cc9223512ec01c405592b6741898}{NUM\_MODE\_SLOTS}}) \{}
\DoxyCodeLine{198     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{199   \}}
\DoxyCodeLine{200   \textcolor{keywordflow}{if} (!buffer.\mbox{\hyperlink{classByteStream_a0ad269c0275cb8856c44a9ea92c59a1a}{init}}(size)) \{}
\DoxyCodeLine{201     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{202   \}}
\DoxyCodeLine{203 \textcolor{preprocessor}{\#ifdef VORTEX\_EMBEDDED}}
\DoxyCodeLine{204   uint8\_t *buf = (uint8\_t *)buffer.\mbox{\hyperlink{classByteStream_a6993f9575592309a501156db31f82554}{rawData}}();}
\DoxyCodeLine{205   \textcolor{keyword}{volatile} uint8\_t *src;}
\DoxyCodeLine{206   \textcolor{keywordflow}{if} (slot == 0) \{ \textcolor{comment}{// slot 0 is header eeprom}}
\DoxyCodeLine{207     src = (\textcolor{keyword}{volatile} uint8\_t *)MAPPED\_EEPROM\_START;}
\DoxyCodeLine{208     size = \mbox{\hyperlink{Storage_8cpp_afb3f89e3b0a79ae35a8a1c0d50ea5b60}{STORAGE\_HEADER\_SIZE}};}
\DoxyCodeLine{209   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (slot < 4) \{ \textcolor{comment}{// slots 1-\/3 are eeprom}}
\DoxyCodeLine{210     src = (\textcolor{keyword}{volatile} uint8\_t *)MAPPED\_EEPROM\_START + \mbox{\hyperlink{Storage_8cpp_afb3f89e3b0a79ae35a8a1c0d50ea5b60}{STORAGE\_HEADER\_SIZE}} + (\mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}} * (slot -\/ 1));}
\DoxyCodeLine{211   \} \textcolor{keywordflow}{else} \{ \textcolor{comment}{// slots 4-\/9 are flash}}
\DoxyCodeLine{212     src = (\textcolor{keyword}{volatile} uint8\_t *)\mbox{\hyperlink{Storage_8cpp_af7b86ca9d41a47f96cf528ab36de4891}{FLASH\_STORAGE\_SPACE}} + (\mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}} * (slot -\/ 4));}
\DoxyCodeLine{213   \}}
\DoxyCodeLine{214   \textcolor{keywordflow}{for} (uint8\_t i = 0; i < size; ++i) \{}
\DoxyCodeLine{215     buf[i] = src[i];}
\DoxyCodeLine{216   \}}
\DoxyCodeLine{217 \textcolor{preprocessor}{\#elif defined(\_WIN32)}}
\DoxyCodeLine{218   HANDLE hFile = CreateFile(\mbox{\hyperlink{Storage_8cpp_a4a8bec941d32acc2e0c33423a61e661f}{STORAGE\_FILENAME}}, GENERIC\_READ, 0, NULL, OPEN\_EXISTING, FILE\_ATTRIBUTE\_NORMAL, NULL);}
\DoxyCodeLine{219   \textcolor{keywordflow}{if} (hFile == INVALID\_HANDLE\_VALUE) \{}
\DoxyCodeLine{220     \textcolor{comment}{// error}}
\DoxyCodeLine{221     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{222   \}}
\DoxyCodeLine{223   DWORD bytesRead = 0;}
\DoxyCodeLine{224   DWORD offset = slot * \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}};}
\DoxyCodeLine{225   SetFilePointer(hFile, offset, NULL, FILE\_BEGIN);}
\DoxyCodeLine{226   \textcolor{keywordflow}{if} (!ReadFile(hFile, buffer.\mbox{\hyperlink{classByteStream_a6993f9575592309a501156db31f82554}{rawData}}(), \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}}, \&bytesRead, NULL)) \{}
\DoxyCodeLine{227     \textcolor{comment}{// error}}
\DoxyCodeLine{228     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{229   \}}
\DoxyCodeLine{230   CloseHandle(hFile);}
\DoxyCodeLine{231 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{232   FILE *f = fopen(\mbox{\hyperlink{Storage_8cpp_a4a8bec941d32acc2e0c33423a61e661f}{STORAGE\_FILENAME}}, \textcolor{stringliteral}{"{}r"{}});}
\DoxyCodeLine{233   \textcolor{keywordflow}{if} (!f) \{}
\DoxyCodeLine{234     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{235   \}}
\DoxyCodeLine{236   \textcolor{keywordtype}{long} offset = slot * \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}};}
\DoxyCodeLine{237   fseek(f, offset, SEEK\_SET);}
\DoxyCodeLine{238   \textcolor{keywordflow}{if} (!fread(buffer.\mbox{\hyperlink{classByteStream_a6993f9575592309a501156db31f82554}{rawData}}(), \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}), \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}}, f)) \{}
\DoxyCodeLine{239     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{240   \}}
\DoxyCodeLine{241   fclose(f);}
\DoxyCodeLine{242 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{243   \textcolor{comment}{// ensure the internal buffer is sane after reading it out, this}}
\DoxyCodeLine{244   \textcolor{comment}{// prevents segfaults if the internal size reports larger than capacity}}
\DoxyCodeLine{245   buffer.\mbox{\hyperlink{classByteStream_ae65462bc14d268fcf0ffccf65f878762}{sanity}}();}
\DoxyCodeLine{246   \textcolor{comment}{// check crc immediately since we read into raw data copying the}}
\DoxyCodeLine{247   \textcolor{comment}{// array could be dangerous}}
\DoxyCodeLine{248   \textcolor{keywordflow}{if} (!buffer.\mbox{\hyperlink{classByteStream_ae3412b7f08252fa2baab4b11cb8c2484}{checkCRC}}()) \{}
\DoxyCodeLine{249     buffer.\mbox{\hyperlink{classByteStream_a854e5507f550826478fd7141074a4bb5}{clear}}();}
\DoxyCodeLine{250     \mbox{\hyperlink{Log_8h_aa12d9b2ced7332bfbb9391da9617561a}{ERROR\_LOG}}(\textcolor{stringliteral}{"{}Could not verify buffer"{}});}
\DoxyCodeLine{251     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{252   \}}
\DoxyCodeLine{253   \mbox{\hyperlink{classStorage_ae85ca521ae89c408fb045d2890951458}{m\_lastSaveSize}} = size;}
\DoxyCodeLine{254   \mbox{\hyperlink{Log_8h_a8bdccae09f7cdda8fb311e0bd81c35dc}{DEBUG\_LOGF}}(\textcolor{stringliteral}{"{}Loaded savedata (Size: \%u)"{}}, buffer.\mbox{\hyperlink{classByteStream_adf87e444e828287c0a43cab2958ca01b}{size}}());}
\DoxyCodeLine{255   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{256 \}}

\end{DoxyCode}


References Byte\+Stream\+::check\+CRC(), Byte\+Stream\+::clear(), DEBUG\+\_\+\+LOGF, ERROR\+\_\+\+LOG, FLASH\+\_\+\+STORAGE\+\_\+\+SPACE, Byte\+Stream\+::init(), m\+\_\+last\+Save\+Size, MAX\+\_\+\+MODE\+\_\+\+SIZE, NUM\+\_\+\+MODE\+\_\+\+SLOTS, Byte\+Stream\+::raw\+Data(), Byte\+Stream\+::sanity(), Byte\+Stream\+::size(), STORAGE\+\_\+\+FILENAME, STORAGE\+\_\+\+HEADER\+\_\+\+SIZE, STORAGE\+\_\+\+SIZE, and Vortex\+::storage\+Enabled().



Referenced by Modes\+::init(), Modes\+::load\+Header(), and Modes\+::load\+Storage().

\mbox{\Hypertarget{classStorage_acbeeb0de638cf1a1861759150721c0b7}\label{classStorage_acbeeb0de638cf1a1861759150721c0b7}} 
\index{Storage@{Storage}!write@{write}}
\index{write@{write}!Storage@{Storage}}
\doxysubsubsection{\texorpdfstring{write()}{write()}}
{\footnotesize\ttfamily bool Storage\+::write (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{slot,  }\item[{\mbox{\hyperlink{classByteStream}{Byte\+Stream}} \&}]{buffer }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 74 of file Storage.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{75 \{}
\DoxyCodeLine{76 \textcolor{preprocessor}{\#ifdef VORTEX\_LIB}}
\DoxyCodeLine{77   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classVortex_aa287fb05ef87acfb1380aeac868d17a1}{Vortex::storageEnabled}}()) \{}
\DoxyCodeLine{78     \textcolor{comment}{// success so the system thinks it all worked}}
\DoxyCodeLine{79     \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{80   \}}
\DoxyCodeLine{81 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{82   \textcolor{comment}{// check size}}
\DoxyCodeLine{83   uint16\_t size = buffer.\mbox{\hyperlink{classByteStream_a755097adde5b21b33d3c4e3623d04f97}{rawSize}}();}
\DoxyCodeLine{84   \textcolor{keywordflow}{if} (buffer.\mbox{\hyperlink{classByteStream_a755097adde5b21b33d3c4e3623d04f97}{rawSize}}() > \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}}) \{}
\DoxyCodeLine{85     \mbox{\hyperlink{Log_8h_aa12d9b2ced7332bfbb9391da9617561a}{ERROR\_LOG}}(\textcolor{stringliteral}{"{}Buffer too big for storage space"{}});}
\DoxyCodeLine{86     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{87   \}}
\DoxyCodeLine{88   \textcolor{keywordflow}{if} (slot >= \mbox{\hyperlink{VortexConfig_8h_ab0c5cc9223512ec01c405592b6741898}{NUM\_MODE\_SLOTS}}) \{}
\DoxyCodeLine{89     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{90   \}}
\DoxyCodeLine{91   \textcolor{comment}{// just in case}}
\DoxyCodeLine{92   buffer.\mbox{\hyperlink{classByteStream_a282f071ea249471c360d364642f9b3c7}{recalcCRC}}();}
\DoxyCodeLine{93 \textcolor{preprocessor}{\#ifdef VORTEX\_EMBEDDED}}
\DoxyCodeLine{94   \textcolor{keyword}{const} uint8\_t *buf = (\textcolor{keyword}{const} uint8\_t *)buffer.\mbox{\hyperlink{classByteStream_a6993f9575592309a501156db31f82554}{rawData}}();}
\DoxyCodeLine{95   \textcolor{comment}{// the header is slot 0 and it gets 17 bytes in the start of the eeprom then}}
\DoxyCodeLine{96   \textcolor{comment}{// the next 3 modes are 76 bytes each taking up 228 bytes for a total of 245}}
\DoxyCodeLine{97   \textcolor{keywordflow}{if} (slot < 4) \{}
\DoxyCodeLine{98     uint8\_t eepSlot = 0;}
\DoxyCodeLine{99     \textcolor{keywordflow}{if} (slot > 0) \{}
\DoxyCodeLine{100       eepSlot = \mbox{\hyperlink{Storage_8cpp_afb3f89e3b0a79ae35a8a1c0d50ea5b60}{STORAGE\_HEADER\_SIZE}} + (\mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}} * (slot -\/ 1));}
\DoxyCodeLine{101     \}}
\DoxyCodeLine{102     \textcolor{comment}{// header eeprom (12 bytes of 256)}}
\DoxyCodeLine{103     \textcolor{comment}{// 3 modes eeprom (76 x 3 bytes of 244)}}
\DoxyCodeLine{104     uint8\_t slotSize = (slot == 0) ? \mbox{\hyperlink{Storage_8cpp_afb3f89e3b0a79ae35a8a1c0d50ea5b60}{STORAGE\_HEADER\_SIZE}} : \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}};}
\DoxyCodeLine{105     \textcolor{keywordflow}{for} (uint8\_t i = 0; i < slotSize; ++i) \{}
\DoxyCodeLine{106       uint8\_t b = (i < size) ? buf[i] : 0x00;}
\DoxyCodeLine{107       \mbox{\hyperlink{classStorage_a9c873bd223652fa8339840a1b350b931}{eepromWriteByte}}(eepSlot + i, b);}
\DoxyCodeLine{108     \}}
\DoxyCodeLine{109   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{110     \textcolor{comment}{// Then flash storage is 0x200 or 512 bytes which allows for 6 x 76 byte modes}}
\DoxyCodeLine{111     \textcolor{comment}{// the base address of the slot we are writing}}
\DoxyCodeLine{112     uint16\_t slotAddr = (uint16\_t)\mbox{\hyperlink{Storage_8cpp_af7b86ca9d41a47f96cf528ab36de4891}{FLASH\_STORAGE\_SPACE}} + (\mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}} * (slot -\/ 4));}
\DoxyCodeLine{113     \textcolor{comment}{// The storage slot may lay across a page boundary which means potentially writing}}
\DoxyCodeLine{114     \textcolor{comment}{// two pages instead of just one. In order to update only part of a page, the page}}
\DoxyCodeLine{115     \textcolor{comment}{// buffer must be filled with both the previous content along with the new data.}}
\DoxyCodeLine{116     \textcolor{comment}{// For example, imagine 2 pages of data: |xxxxxxSSSS|SSSxxxxxxx| the x's are other}}
\DoxyCodeLine{117     \textcolor{comment}{// data that must be preserved, and the S's denote the storage slot being written.}}
\DoxyCodeLine{118     \textcolor{comment}{// This would take place over two iterations of the loop, each writing out one page}}
\DoxyCodeLine{119     \textcolor{comment}{// by read-\/then-\/writing-\/back the x's and writing out the new S's. This is necessary}}
\DoxyCodeLine{120     \textcolor{comment}{// because the page buffer must be filled to perform a page write, at least I think}}
\DoxyCodeLine{121     \textcolor{keywordflow}{while} (size > 0) \{}
\DoxyCodeLine{122       uint16\_t pageStart = slotAddr \& \string~(\mbox{\hyperlink{Storage_8cpp_a4cc14e2c99ae7f8e5a8e371d03c8532c}{FLASH\_PAGE\_SIZE}} -\/ 1);}
\DoxyCodeLine{123       uint16\_t offset = slotAddr \% \mbox{\hyperlink{Storage_8cpp_a4cc14e2c99ae7f8e5a8e371d03c8532c}{FLASH\_PAGE\_SIZE}};}
\DoxyCodeLine{124       uint16\_t space = \mbox{\hyperlink{Storage_8cpp_a4cc14e2c99ae7f8e5a8e371d03c8532c}{FLASH\_PAGE\_SIZE}} -\/ offset;}
\DoxyCodeLine{125       uint16\_t writeSize = (size < space) ? size : space;}
\DoxyCodeLine{126 }
\DoxyCodeLine{127       \textcolor{keywordflow}{for} (uint8\_t i = 0; i < \mbox{\hyperlink{Storage_8cpp_a4cc14e2c99ae7f8e5a8e371d03c8532c}{FLASH\_PAGE\_SIZE}}; ++i) \{}
\DoxyCodeLine{128         uint8\_t value;}
\DoxyCodeLine{129         \textcolor{keywordflow}{if} (i >= offset \&\& i < offset + writeSize) \{}
\DoxyCodeLine{130           \textcolor{comment}{// if this is within the slot then write out the new data}}
\DoxyCodeLine{131           value = buf[i -\/ offset];}
\DoxyCodeLine{132         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{133           \textcolor{comment}{// otherwise just write-\/back the same value to fill the pagebuffer}}
\DoxyCodeLine{134           value = *(\textcolor{keyword}{volatile} uint8\_t *)(pageStart + i);}
\DoxyCodeLine{135         \}}
\DoxyCodeLine{136         *(\textcolor{keyword}{volatile} uint8\_t *)(pageStart + i) = value;}
\DoxyCodeLine{137       \}}
\DoxyCodeLine{138 }
\DoxyCodeLine{139       \textcolor{comment}{// Erase and write the flash page}}
\DoxyCodeLine{140       \_PROTECTED\_WRITE\_SPM(NVMCTRL.CTRLA, NVMCTRL\_CMD\_PAGEERASEWRITE\_gc);}
\DoxyCodeLine{141       \textcolor{keywordflow}{while} (NVMCTRL.STATUS \& (NVMCTRL\_FBUSY\_bm | NVMCTRL\_EEBUSY\_bm));}
\DoxyCodeLine{142 }
\DoxyCodeLine{143       \textcolor{comment}{// continue to the next page}}
\DoxyCodeLine{144       slotAddr += writeSize;}
\DoxyCodeLine{145       buf += writeSize;}
\DoxyCodeLine{146       size -\/= writeSize;}
\DoxyCodeLine{147     \}}
\DoxyCodeLine{148   \}}
\DoxyCodeLine{149 \textcolor{preprocessor}{\#elif defined(\_WIN32)}}
\DoxyCodeLine{150   HANDLE hFile = CreateFile(\mbox{\hyperlink{Storage_8cpp_a4a8bec941d32acc2e0c33423a61e661f}{STORAGE\_FILENAME}}, GENERIC\_READ | GENERIC\_WRITE, 0, NULL, OPEN\_ALWAYS, FILE\_ATTRIBUTE\_NORMAL, NULL);}
\DoxyCodeLine{151   \textcolor{keywordflow}{if} (hFile == INVALID\_HANDLE\_VALUE) \{}
\DoxyCodeLine{152     \textcolor{comment}{// error}}
\DoxyCodeLine{153     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{154   \}}
\DoxyCodeLine{155   DWORD written = 0;}
\DoxyCodeLine{156   DWORD offset = slot * \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}};}
\DoxyCodeLine{157   SetFilePointer(hFile, offset, NULL, FILE\_BEGIN);}
\DoxyCodeLine{158   uint8\_t modeBuffer[\mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}}] = \{0\};}
\DoxyCodeLine{159   \textcolor{comment}{// copy the mode data into a temp buffer}}
\DoxyCodeLine{160   memcpy(modeBuffer, buffer.\mbox{\hyperlink{classByteStream_a6993f9575592309a501156db31f82554}{rawData}}(), size);}
\DoxyCodeLine{161   \textcolor{comment}{// then copy the full size of the temp buffer in}}
\DoxyCodeLine{162   \textcolor{keywordflow}{if} (!WriteFile(hFile, modeBuffer, \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}}, \&written, NULL)) \{}
\DoxyCodeLine{163     \textcolor{comment}{// error}}
\DoxyCodeLine{164     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{165   \}}
\DoxyCodeLine{166   CloseHandle(hFile);}
\DoxyCodeLine{167 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{168   FILE *f = fopen(\mbox{\hyperlink{Storage_8cpp_a4a8bec941d32acc2e0c33423a61e661f}{STORAGE\_FILENAME}}, \textcolor{stringliteral}{"{}w"{}});}
\DoxyCodeLine{169   \textcolor{keywordflow}{if} (!f) \{}
\DoxyCodeLine{170     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{171   \}}
\DoxyCodeLine{172   \textcolor{keywordtype}{long} offset = slot * \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}};}
\DoxyCodeLine{173   fseek(f, offset, SEEK\_SET);}
\DoxyCodeLine{174   uint8\_t modeBuffer[\mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}}] = \{0\};}
\DoxyCodeLine{175   \textcolor{comment}{// copy the mode data into a temp buffer}}
\DoxyCodeLine{176   memcpy(modeBuffer, buffer.\mbox{\hyperlink{classByteStream_a6993f9575592309a501156db31f82554}{rawData}}(), size);}
\DoxyCodeLine{177   \textcolor{keywordflow}{if} (!fwrite(modeBuffer, \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}), \mbox{\hyperlink{VortexConfig_8h_a4d5f0e0392f00d31715ddf81eb87434a}{MAX\_MODE\_SIZE}}, f)) \{}
\DoxyCodeLine{178     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{179   \}}
\DoxyCodeLine{180   fclose(f);}
\DoxyCodeLine{181 \textcolor{preprocessor}{\#endif }\textcolor{comment}{// VORTEX\_EMBEDDED}}
\DoxyCodeLine{182   \mbox{\hyperlink{Log_8h_a8bdccae09f7cdda8fb311e0bd81c35dc}{DEBUG\_LOGF}}(\textcolor{stringliteral}{"{}Wrote \%u bytes to storage (max: \%u)"{}}, \mbox{\hyperlink{classStorage_ae85ca521ae89c408fb045d2890951458}{m\_lastSaveSize}}, \mbox{\hyperlink{VortexConfig_8h_a8d6f782ffe53d87f0fd0327d4b09352c}{STORAGE\_SIZE}});}
\DoxyCodeLine{183   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{184 \}}

\end{DoxyCode}


References DEBUG\+\_\+\+LOGF, eeprom\+Write\+Byte(), ERROR\+\_\+\+LOG, FLASH\+\_\+\+PAGE\+\_\+\+SIZE, FLASH\+\_\+\+STORAGE\+\_\+\+SPACE, m\+\_\+last\+Save\+Size, MAX\+\_\+\+MODE\+\_\+\+SIZE, NUM\+\_\+\+MODE\+\_\+\+SLOTS, Byte\+Stream\+::raw\+Data(), Byte\+Stream\+::raw\+Size(), Byte\+Stream\+::recalc\+CRC(), STORAGE\+\_\+\+FILENAME, STORAGE\+\_\+\+HEADER\+\_\+\+SIZE, STORAGE\+\_\+\+SIZE, and Vortex\+::storage\+Enabled().



Referenced by Modes\+::save\+Header(), and Modes\+::save\+Storage().



\doxysubsection{Member Data Documentation}
\mbox{\Hypertarget{classStorage_ae85ca521ae89c408fb045d2890951458}\label{classStorage_ae85ca521ae89c408fb045d2890951458}} 
\index{Storage@{Storage}!m\_lastSaveSize@{m\_lastSaveSize}}
\index{m\_lastSaveSize@{m\_lastSaveSize}!Storage@{Storage}}
\doxysubsubsection{\texorpdfstring{m\_lastSaveSize}{m\_lastSaveSize}}
{\footnotesize\ttfamily uint32\+\_\+t Storage\+::m\+\_\+last\+Save\+Size = 0\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}



Definition at line 44 of file Storage.\+h.



Referenced by last\+Save\+Size(), read(), and write().



The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
Vortex\+Engine/src/\+Storage/\mbox{\hyperlink{Storage_8h}{Storage.\+h}}\item 
Vortex\+Engine/src/\+Storage/\mbox{\hyperlink{Storage_8cpp}{Storage.\+cpp}}\end{DoxyCompactItemize}
