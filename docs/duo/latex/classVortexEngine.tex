\hypertarget{classVortexEngine}{}\doxysection{Vortex\+Engine Class Reference}
\label{classVortexEngine}\index{VortexEngine@{VortexEngine}}


{\ttfamily \#include $<$Vortex\+Engine.\+h$>$}

\doxysubsection*{Static Public Member Functions}
\begin{DoxyCompactItemize}
\item 
static bool \mbox{\hyperlink{classVortexEngine_a7d0883a55ea519ac58a24637c0cc38d2}{init}} ()
\item 
static void \mbox{\hyperlink{classVortexEngine_ae80679477cd0c0f726e610b26fc1a6db}{cleanup}} ()
\item 
static void \mbox{\hyperlink{classVortexEngine_ad824edd37d12e0ba7efafd8cd844e1b7}{tick}} ()
\item 
static void \mbox{\hyperlink{classVortexEngine_ad8500f86579f3e6d9f887698e181b4d2}{run\+Main\+Logic}} ()
\item 
static bool \mbox{\hyperlink{classVortexEngine_a194a57be4545c9e7d0ceb0df6cf3d7e8}{serialize\+Version}} (\mbox{\hyperlink{classByteStream}{Byte\+Stream}} \&stream)
\item 
static bool \mbox{\hyperlink{classVortexEngine_aa85a9e4f12bc72bedd7b0a9c5a9bd970}{check\+Version}} (uint8\+\_\+t major, uint8\+\_\+t minor)
\item 
static \mbox{\hyperlink{classMode}{Mode}} $\ast$ \mbox{\hyperlink{classVortexEngine_affa9de921adbc32fd04e0b10143a8e58}{cur\+Mode}} ()
\item 
static void \mbox{\hyperlink{classVortexEngine_a4b2b59ca72d6cd1115ac6cd7c1672e44}{enter\+Sleep}} (bool save=true)
\item 
static void \mbox{\hyperlink{classVortexEngine_a32e7878bb1f4e4c4d141e849ff7808fb}{wakeup}} (bool reset=true)
\item 
static void \mbox{\hyperlink{classVortexEngine_af00c20421c2dc846493a17109c462bb4}{toggle\+Force\+Sleep}} (bool enabled)
\item 
static void \mbox{\hyperlink{classVortexEngine_ae262a231ee6fe1d7adc834b30725e114}{clear\+Output\+Pins}} ()
\item 
static void \mbox{\hyperlink{classVortexEngine_ad1132c049a66099d3a35e6850db6d629}{enable\+MOSFET}} (bool enabled)
\end{DoxyCompactItemize}
\doxysubsection*{Private Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classVortexEngine_aa41d7d79ef441d989d1d8deaf3490ccd}{Vortex\+Engine}} ()
\end{DoxyCompactItemize}
\doxysubsection*{Static Private Attributes}
\begin{DoxyCompactItemize}
\item 
static volatile bool \mbox{\hyperlink{classVortexEngine_a68bdf824c4c7b2303a1b1a37da67f496}{m\+\_\+sleeping}} = false
\item 
static bool \mbox{\hyperlink{classVortexEngine_a139832c7933b4a4e0419787c56b4ef2b}{m\+\_\+force\+Sleep\+Enabled}} = true
\item 
static bool \mbox{\hyperlink{classVortexEngine_ae6812312d6c117bf487ea7d2754f8063}{m\+\_\+auto\+Cycle}} = false
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


Definition at line 10 of file Vortex\+Engine.\+h.



\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{classVortexEngine_aa41d7d79ef441d989d1d8deaf3490ccd}\label{classVortexEngine_aa41d7d79ef441d989d1d8deaf3490ccd}} 
\index{VortexEngine@{VortexEngine}!VortexEngine@{VortexEngine}}
\index{VortexEngine@{VortexEngine}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{VortexEngine()}{VortexEngine()}}
{\footnotesize\ttfamily Vortex\+Engine\+::\+Vortex\+Engine (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [private]}}



\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{classVortexEngine_aa85a9e4f12bc72bedd7b0a9c5a9bd970}\label{classVortexEngine_aa85a9e4f12bc72bedd7b0a9c5a9bd970}} 
\index{VortexEngine@{VortexEngine}!checkVersion@{checkVersion}}
\index{checkVersion@{checkVersion}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{checkVersion()}{checkVersion()}}
{\footnotesize\ttfamily bool Vortex\+Engine\+::check\+Version (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{major,  }\item[{uint8\+\_\+t}]{minor }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 328 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{329 \{}
\DoxyCodeLine{330   \textcolor{keywordflow}{if} (major != \mbox{\hyperlink{VortexConfig_8h_ad51691e0bf3c0a33a9b4929507a7d4d8}{VORTEX\_VERSION\_MAJOR}}) \{}
\DoxyCodeLine{331     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{332   \}}
\DoxyCodeLine{333   \textcolor{comment}{// minor version doesn't matter}}
\DoxyCodeLine{334   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{335 \}}

\end{DoxyCode}


References VORTEX\+\_\+\+VERSION\+\_\+\+MAJOR.



Referenced by Mode\+::load\+From\+Buffer(), and Modes\+::load\+From\+Buffer().

\mbox{\Hypertarget{classVortexEngine_ae80679477cd0c0f726e610b26fc1a6db}\label{classVortexEngine_ae80679477cd0c0f726e610b26fc1a6db}} 
\index{VortexEngine@{VortexEngine}!cleanup@{cleanup}}
\index{cleanup@{cleanup}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{cleanup()}{cleanup()}}
{\footnotesize\ttfamily void Vortex\+Engine\+::cleanup (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 110 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{111 \{}
\DoxyCodeLine{112   \textcolor{comment}{// cleanup in reverse order}}
\DoxyCodeLine{113   \textcolor{comment}{// NOTE: the arduino doesn't actually cleanup,}}
\DoxyCodeLine{114   \textcolor{comment}{//       but the test frameworks do}}
\DoxyCodeLine{115 \textcolor{preprocessor}{\#ifdef VORTEX\_LIB}}
\DoxyCodeLine{116   \mbox{\hyperlink{classModes_aa16cf03f84bc5d911d220580ba3aeb7a}{Modes::cleanup}}();}
\DoxyCodeLine{117   \mbox{\hyperlink{classMenus_afb9e47baa1d7322d865bc025202d7b9b}{Menus::cleanup}}();}
\DoxyCodeLine{118   \mbox{\hyperlink{classButtons_a4bee1374d1782a6006faee6f9d9bb792}{Buttons::cleanup}}();}
\DoxyCodeLine{119   \mbox{\hyperlink{classLeds_a2292420b1011485e315eff165bb201cf}{Leds::cleanup}}();}
\DoxyCodeLine{120   \mbox{\hyperlink{classVLSender_a49afba3c3cae06136ad8744e367fcdb3}{VLSender::cleanup}}();}
\DoxyCodeLine{121   \mbox{\hyperlink{classVLReceiver_a31fba601a6e82bc043c7d017d91ce015}{VLReceiver::cleanup}}();}
\DoxyCodeLine{122   \mbox{\hyperlink{classStorage_a2a1ce108c9a17f6175bfb9a9aba51703}{Storage::cleanup}}();}
\DoxyCodeLine{123   \mbox{\hyperlink{classTime_af813bd1f7e4c08f6d84f8831738fed32}{Time::cleanup}}();}
\DoxyCodeLine{124 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{125 \}}

\end{DoxyCode}


References Buttons\+::cleanup(), Leds\+::cleanup(), Menus\+::cleanup(), Modes\+::cleanup(), Storage\+::cleanup(), Time\+::cleanup(), VLReceiver\+::cleanup(), and VLSender\+::cleanup().



Referenced by wakeup().

\mbox{\Hypertarget{classVortexEngine_ae262a231ee6fe1d7adc834b30725e114}\label{classVortexEngine_ae262a231ee6fe1d7adc834b30725e114}} 
\index{VortexEngine@{VortexEngine}!clearOutputPins@{clearOutputPins}}
\index{clearOutputPins@{clearOutputPins}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{clearOutputPins()}{clearOutputPins()}}
{\footnotesize\ttfamily void Vortex\+Engine\+::clear\+Output\+Pins (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 426 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{427 \{}
\DoxyCodeLine{428   \textcolor{comment}{// Set all pins to input with pull-\/ups}}
\DoxyCodeLine{429   PORTA.DIRCLR = 0xFF;}
\DoxyCodeLine{430   PORTA.PIN0CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{431   PORTA.PIN1CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{432   PORTA.PIN2CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{433   PORTA.PIN3CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{434   PORTA.PIN4CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{435   PORTA.PIN5CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{436   PORTA.PIN6CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{437   PORTA.PIN7CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{438   PORTB.DIRCLR = 0xFF;}
\DoxyCodeLine{439   PORTB.PIN0CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{440   PORTB.PIN1CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{441   PORTB.PIN2CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{442   PORTB.PIN3CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{443   PORTB.PIN4CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{444   PORTB.PIN5CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{445   PORTB.PIN6CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{446   PORTB.PIN7CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{447   PORTC.DIRCLR = 0xFF;}
\DoxyCodeLine{448   PORTC.PIN0CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{449   PORTC.PIN1CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{450   PORTC.PIN2CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{451   PORTC.PIN3CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{452   PORTC.PIN4CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{453   PORTC.PIN5CTRL = PORT\_ISC\_INPUT\_DISABLE\_gc;}
\DoxyCodeLine{454 \}}

\end{DoxyCode}


Referenced by enter\+Sleep(), and init().

\mbox{\Hypertarget{classVortexEngine_affa9de921adbc32fd04e0b10143a8e58}\label{classVortexEngine_affa9de921adbc32fd04e0b10143a8e58}} 
\index{VortexEngine@{VortexEngine}!curMode@{curMode}}
\index{curMode@{curMode}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{curMode()}{curMode()}}
{\footnotesize\ttfamily \mbox{\hyperlink{classMode}{Mode}} $\ast$ Vortex\+Engine\+::cur\+Mode (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 337 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{338 \{}
\DoxyCodeLine{339 \textcolor{preprocessor}{\#ifdef VORTEX\_LIB}}
\DoxyCodeLine{340   \textcolor{keywordflow}{return} \mbox{\hyperlink{classModes_a1e520dc2ee457bc93a795e9945249dbd}{Modes::curMode}}();}
\DoxyCodeLine{341 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{342   \textcolor{comment}{// don't need this outside vortex lib}}
\DoxyCodeLine{343   \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};}
\DoxyCodeLine{344 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{345 \}}

\end{DoxyCode}


References Modes\+::cur\+Mode().

\mbox{\Hypertarget{classVortexEngine_ad1132c049a66099d3a35e6850db6d629}\label{classVortexEngine_ad1132c049a66099d3a35e6850db6d629}} 
\index{VortexEngine@{VortexEngine}!enableMOSFET@{enableMOSFET}}
\index{enableMOSFET@{enableMOSFET}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{enableMOSFET()}{enableMOSFET()}}
{\footnotesize\ttfamily void Vortex\+Engine\+::enable\+MOSFET (\begin{DoxyParamCaption}\item[{bool}]{enabled }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 456 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{457 \{}
\DoxyCodeLine{458   PORTC.DIRSET |= PIN4\_bm;}
\DoxyCodeLine{459   \textcolor{keywordflow}{if} (enabled) \{}
\DoxyCodeLine{460     \textcolor{comment}{// Set Mosfet pin (PC4) to output and set it HIGH}}
\DoxyCodeLine{461     PORTC.OUTSET |= PIN4\_bm;}
\DoxyCodeLine{462   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{463     \textcolor{comment}{// Set Mosfet pin (PC4) to output and set it LOW}}
\DoxyCodeLine{464     PORTC.OUTCLR |= PIN4\_bm;}
\DoxyCodeLine{465   \}}
\DoxyCodeLine{466 \}}

\end{DoxyCode}


Referenced by enter\+Sleep(), init(), run\+Main\+Logic(), and wakeup().

\mbox{\Hypertarget{classVortexEngine_a4b2b59ca72d6cd1115ac6cd7c1672e44}\label{classVortexEngine_a4b2b59ca72d6cd1115ac6cd7c1672e44}} 
\index{VortexEngine@{VortexEngine}!enterSleep@{enterSleep}}
\index{enterSleep@{enterSleep}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{enterSleep()}{enterSleep()}}
{\footnotesize\ttfamily void Vortex\+Engine\+::enter\+Sleep (\begin{DoxyParamCaption}\item[{bool}]{save = {\ttfamily true} }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 359 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{360 \{}
\DoxyCodeLine{361   \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}Sleeping"{}});}
\DoxyCodeLine{362   \textcolor{keywordflow}{if} (save) \{}
\DoxyCodeLine{363     \textcolor{comment}{// update the startup mode when going to sleep}}
\DoxyCodeLine{364     \mbox{\hyperlink{classModes_a86dc60444399ab04d49f77935f68e8dd}{Modes::setStartupMode}}(\mbox{\hyperlink{classModes_a7a1b8d5c48237ab106adbfc44ceb1055}{Modes::curModeIndex}}());}
\DoxyCodeLine{365     \textcolor{comment}{// save anything that hasn't been saved}}
\DoxyCodeLine{366     \mbox{\hyperlink{classModes_a1756081ee85dbcf672ddad5a3dcb4690}{Modes::saveStorage}}();}
\DoxyCodeLine{367   \}}
\DoxyCodeLine{368   \textcolor{comment}{// clear all the leds}}
\DoxyCodeLine{369   \mbox{\hyperlink{classLeds_a6f7c9cdfab407455403167fd8f2c350a}{Leds::clearAll}}();}
\DoxyCodeLine{370   \mbox{\hyperlink{classLeds_a7b552b40079b1179fd47f7aeea88878d}{Leds::update}}();}
\DoxyCodeLine{371 \textcolor{preprocessor}{\#ifdef VORTEX\_EMBEDDED}}
\DoxyCodeLine{372   \textcolor{comment}{// init the output pins to prevent any floating pins}}
\DoxyCodeLine{373   \mbox{\hyperlink{classVortexEngine_ae262a231ee6fe1d7adc834b30725e114}{clearOutputPins}}();}
\DoxyCodeLine{374   \textcolor{comment}{// close the mosfet so that power cannot flow to the leds}}
\DoxyCodeLine{375   \mbox{\hyperlink{classVortexEngine_ad1132c049a66099d3a35e6850db6d629}{enableMOSFET}}(\textcolor{keyword}{false});}
\DoxyCodeLine{376   \textcolor{comment}{// delay for a bit to let the mosfet close and leds turn off}}
\DoxyCodeLine{377   \mbox{\hyperlink{classTime_a9682da1974a20a9bcdbb678984cd0e9c}{Time::delayMicroseconds}}(250);}
\DoxyCodeLine{378   \textcolor{comment}{// this is an ISR that runs in the timecontrol system to handle}}
\DoxyCodeLine{379   \textcolor{comment}{// micros, it will wake the device up periodically}}
\DoxyCodeLine{380   TCB0.INTCTRL = 0;}
\DoxyCodeLine{381   TCB0.CTRLA = 0;}
\DoxyCodeLine{382   \textcolor{comment}{// Enable wake on interrupt for the button}}
\DoxyCodeLine{383   \mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_afc1f76677aed5c89139aed6daa5f5d4a}{enableWake}}();}
\DoxyCodeLine{384   \textcolor{comment}{// Set sleep mode to POWER DOWN mode}}
\DoxyCodeLine{385   set\_sleep\_mode(SLEEP\_MODE\_PWR\_DOWN);}
\DoxyCodeLine{386   \textcolor{comment}{// enable the sleep boo lright before we enter sleep, this will allow}}
\DoxyCodeLine{387   \textcolor{comment}{// the main loop to break and return}}
\DoxyCodeLine{388   \mbox{\hyperlink{classVortexEngine_a68bdf824c4c7b2303a1b1a37da67f496}{m\_sleeping}} = \textcolor{keyword}{true};}
\DoxyCodeLine{389   \textcolor{comment}{// enter sleep}}
\DoxyCodeLine{390   sleep\_mode();}
\DoxyCodeLine{391 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{392   \textcolor{comment}{// enable the sleep bool}}
\DoxyCodeLine{393   \mbox{\hyperlink{classVortexEngine_a68bdf824c4c7b2303a1b1a37da67f496}{m\_sleeping}} = \textcolor{keyword}{true};}
\DoxyCodeLine{394 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{395 \}}

\end{DoxyCode}


References Leds\+::clear\+All(), clear\+Output\+Pins(), Modes\+::cur\+Mode\+Index(), DEBUG\+\_\+\+LOG, Time\+::delay\+Microseconds(), enable\+MOSFET(), Button\+::enable\+Wake(), g\+\_\+p\+Button, m\+\_\+sleeping, Modes\+::save\+Storage(), Modes\+::set\+Startup\+Mode(), and Leds\+::update().



Referenced by Modes\+::play(), Global\+Brightness\+::run\+Keychain\+Mode(), and run\+Main\+Logic().

\mbox{\Hypertarget{classVortexEngine_a7d0883a55ea519ac58a24637c0cc38d2}\label{classVortexEngine_a7d0883a55ea519ac58a24637c0cc38d2}} 
\index{VortexEngine@{VortexEngine}!init@{init}}
\index{init@{init}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{init()}{init()}}
{\footnotesize\ttfamily bool Vortex\+Engine\+::init (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 36 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{37 \{}
\DoxyCodeLine{38 \textcolor{preprocessor}{\#ifdef VORTEX\_EMBEDDED}}
\DoxyCodeLine{39   \textcolor{comment}{// clear the output pins to initialize everything}}
\DoxyCodeLine{40   \mbox{\hyperlink{classVortexEngine_ae262a231ee6fe1d7adc834b30725e114}{clearOutputPins}}();}
\DoxyCodeLine{41 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{42 }
\DoxyCodeLine{43   \textcolor{comment}{// all of the global controllers}}
\DoxyCodeLine{44   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classTime_a0058db559daacf8050e8a0b1d4b9fd8c}{Time::init}}()) \{}
\DoxyCodeLine{45     \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}Time failed to initialize"{}});}
\DoxyCodeLine{46     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{47   \}}
\DoxyCodeLine{48   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classStorage_a065812a8dbd82d731291b5aa7ce3edf9}{Storage::init}}()) \{}
\DoxyCodeLine{49     \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}Storage failed to initialize"{}});}
\DoxyCodeLine{50     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{51   \}}
\DoxyCodeLine{52   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classVLReceiver_a406cd003a5d26bfe07470261fdb022c1}{VLReceiver::init}}()) \{}
\DoxyCodeLine{53     \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}VLReceiver failed to initialize"{}});}
\DoxyCodeLine{54     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{55   \}}
\DoxyCodeLine{56   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classVLSender_afe2303e108c0aad37695e257f1ba4dad}{VLSender::init}}()) \{}
\DoxyCodeLine{57     \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}VLSender failed to initialize"{}});}
\DoxyCodeLine{58     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{59   \}}
\DoxyCodeLine{60   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classLeds_aa470a02f29041f373be156dc698ed4c7}{Leds::init}}()) \{}
\DoxyCodeLine{61     \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}Leds failed to initialize"{}});}
\DoxyCodeLine{62     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{63   \}}
\DoxyCodeLine{64   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classButtons_ac5767a8af9ce64e39231833ad1b166ea}{Buttons::init}}()) \{}
\DoxyCodeLine{65     \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}Buttons failed to initialize"{}});}
\DoxyCodeLine{66     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{67   \}}
\DoxyCodeLine{68   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classMenus_a370c7e15fdcd035a2816b9db1adab189}{Menus::init}}()) \{}
\DoxyCodeLine{69     \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}Menus failed to initialize"{}});}
\DoxyCodeLine{70     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{71   \}}
\DoxyCodeLine{72   \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classModes_a8b920de981d96ca9365b766a3f59fb73}{Modes::init}}()) \{}
\DoxyCodeLine{73     \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}Settings failed to initialize"{}});}
\DoxyCodeLine{74     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{75   \}}
\DoxyCodeLine{76 }
\DoxyCodeLine{77 \textcolor{preprocessor}{\#if COMPRESSION\_TEST == 1}}
\DoxyCodeLine{78   compressionTest();}
\DoxyCodeLine{79 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{80 }
\DoxyCodeLine{81 \textcolor{preprocessor}{\#if SERIALIZATION\_TEST == 1}}
\DoxyCodeLine{82   serializationTest();}
\DoxyCodeLine{83 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{84 }
\DoxyCodeLine{85 \textcolor{preprocessor}{\#if TIMER\_TEST == 1}}
\DoxyCodeLine{86   timerTest();}
\DoxyCodeLine{87 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{88 }
\DoxyCodeLine{89 \textcolor{preprocessor}{\#ifdef VORTEX\_EMBEDDED}}
\DoxyCodeLine{90   \textcolor{comment}{// setup TCB0 to track micros() and run ticks}}
\DoxyCodeLine{91   TCB0.CCMP = 10000;}
\DoxyCodeLine{92   TCB0.INTCTRL = TCB\_CAPT\_bm;}
\DoxyCodeLine{93   \textcolor{comment}{// Set clock source to CPU divided by 1, Keep running in sleep mode, Enable TCB}}
\DoxyCodeLine{94   TCB0.CTRLA = TCB\_CLKSEL\_CLKDIV1\_gc | TCB\_RUNSTDBY\_bm | TCB\_ENABLE\_bm;}
\DoxyCodeLine{95   \textcolor{comment}{// set the state of the mosfet based on whether the chip is locked or not}}
\DoxyCodeLine{96   \mbox{\hyperlink{classVortexEngine_ad1132c049a66099d3a35e6850db6d629}{enableMOSFET}}(!\mbox{\hyperlink{classModes_abe515fae0059b1213ba544b613051e97}{Modes::locked}}());}
\DoxyCodeLine{97   \textcolor{comment}{// setup sleep mode for standby}}
\DoxyCodeLine{98   set\_sleep\_mode(SLEEP\_MODE\_STANDBY);}
\DoxyCodeLine{99   \textcolor{comment}{// enable interrupts}}
\DoxyCodeLine{100   sei();}
\DoxyCodeLine{101   \textcolor{comment}{// standby indefinitely while the ISR runs VortexEngine::tick}}
\DoxyCodeLine{102   \textcolor{keywordflow}{while} (!\mbox{\hyperlink{classVortexEngine_a68bdf824c4c7b2303a1b1a37da67f496}{m\_sleeping}}) \{}
\DoxyCodeLine{103     sleep\_mode();}
\DoxyCodeLine{104   \}}
\DoxyCodeLine{105 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{106 }
\DoxyCodeLine{107   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{108 \}}

\end{DoxyCode}


References clear\+Output\+Pins(), DEBUG\+\_\+\+LOG, enable\+MOSFET(), Buttons\+::init(), Leds\+::init(), Menus\+::init(), Modes\+::init(), Storage\+::init(), Time\+::init(), VLReceiver\+::init(), VLSender\+::init(), Modes\+::locked(), and m\+\_\+sleeping.



Referenced by wakeup().

\mbox{\Hypertarget{classVortexEngine_ad8500f86579f3e6d9f887698e181b4d2}\label{classVortexEngine_ad8500f86579f3e6d9f887698e181b4d2}} 
\index{VortexEngine@{VortexEngine}!runMainLogic@{runMainLogic}}
\index{runMainLogic@{runMainLogic}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{runMainLogic()}{runMainLogic()}}
{\footnotesize\ttfamily void Vortex\+Engine\+::run\+Main\+Logic (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 169 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{170 \{}
\DoxyCodeLine{171   \textcolor{comment}{// the current tick}}
\DoxyCodeLine{172   uint32\_t now = \mbox{\hyperlink{classTime_a7c7a8e067bdbd5aaf119521539d30940}{Time::getCurtime}}();}
\DoxyCodeLine{173 }
\DoxyCodeLine{174   \textcolor{comment}{// if the device is locked then that takes priority over all, while locked the}}
\DoxyCodeLine{175   \textcolor{comment}{// device will only listen for clicks to wakeup momentarily then go back to sleep}}
\DoxyCodeLine{176   \textcolor{keywordflow}{if} (\mbox{\hyperlink{classModes_abe515fae0059b1213ba544b613051e97}{Modes::locked}}()) \{}
\DoxyCodeLine{177     \textcolor{comment}{// several fast clicks will unlock the device}}
\DoxyCodeLine{178     \textcolor{keywordflow}{if} (\mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_af08888134084d0640b6a891bdb755f14}{onConsecutivePresses}}(\mbox{\hyperlink{VortexConfig_8h_a2f5ef442fae5fcc560776b23fa1ccef3}{DEVICE\_LOCK\_CLICKS}} -\/ 1)) \{}
\DoxyCodeLine{179       \textcolor{comment}{// turn off the lock flag and save it to disk}}
\DoxyCodeLine{180       \mbox{\hyperlink{classModes_a1ae90978222b457a941f0cbf7dd9b46b}{Modes::setLocked}}(\textcolor{keyword}{false});}
\DoxyCodeLine{181 \textcolor{preprocessor}{\#ifdef VORTEX\_EMBEDDED}}
\DoxyCodeLine{182       \textcolor{comment}{// then enable the mosfet}}
\DoxyCodeLine{183       \mbox{\hyperlink{classVortexEngine_ad1132c049a66099d3a35e6850db6d629}{enableMOSFET}}(\textcolor{keyword}{true});}
\DoxyCodeLine{184 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{185     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (now > (\mbox{\hyperlink{Timings_8h_ae76f1a92ba0f97abcfa5007efb8acb35}{CONSECUTIVE\_WINDOW\_TICKS}} * \mbox{\hyperlink{VortexConfig_8h_a2f5ef442fae5fcc560776b23fa1ccef3}{DEVICE\_LOCK\_CLICKS}})) \{}
\DoxyCodeLine{186       \textcolor{comment}{// go back to sleep if they don't unlock in time, don't save}}
\DoxyCodeLine{187       \mbox{\hyperlink{classVortexEngine_a4b2b59ca72d6cd1115ac6cd7c1672e44}{enterSleep}}(\textcolor{keyword}{false});}
\DoxyCodeLine{188     \}}
\DoxyCodeLine{189     \textcolor{comment}{// OPTIONAL: render a dim led during unlock window waiting for clicks?}}
\DoxyCodeLine{190     \textcolor{comment}{//Leds::setIndex(LED\_1, RGB\_RED4);}}
\DoxyCodeLine{191     \mbox{\hyperlink{classLeds_a6f7c9cdfab407455403167fd8f2c350a}{Leds::clearAll}}();}
\DoxyCodeLine{192     \textcolor{comment}{// don't do anything else while locked, just return}}
\DoxyCodeLine{193     \textcolor{keywordflow}{return};}
\DoxyCodeLine{194   \}}
\DoxyCodeLine{195 }
\DoxyCodeLine{196   \textcolor{comment}{// the device is not locked, proceed with regular logic}}
\DoxyCodeLine{197 }
\DoxyCodeLine{198   \textcolor{comment}{// if the button hasn't been released since turning on then there is custom logic}}
\DoxyCodeLine{199   \textcolor{keywordflow}{if} (\mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_ac0aa91f0b81ee39d29e298c522989a3d}{releaseCount}}() == 0) \{}
\DoxyCodeLine{200     \textcolor{comment}{// if the button is held for 2 seconds from off, switch to on click mode on}}
\DoxyCodeLine{201     \textcolor{comment}{// the last mode shown before sleep}}
\DoxyCodeLine{202     \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classModes_a576b63195795fa9c7c41ae9ac65e4334}{Modes::keychainModeEnabled}}() \&\& now == \mbox{\hyperlink{Timings_8h_a32ea38467ac4da30d730fee6cb4e88b2}{ONE\_CLICK\_THRESHOLD\_TICKS}} \&\& \mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_a6ed2a4b4e00facf5c42a11ecd1f4e1c7}{isPressed}}()) \{}
\DoxyCodeLine{203       \textcolor{comment}{// whether oneclick mode is now enabled}}
\DoxyCodeLine{204       \textcolor{keywordtype}{bool} isEnabledNow = !\mbox{\hyperlink{classModes_a05f64b5430343cc94e77902b02fb8ce1}{Modes::oneClickModeEnabled}}();}
\DoxyCodeLine{205       \textcolor{comment}{// toggle one click mode}}
\DoxyCodeLine{206       \mbox{\hyperlink{classModes_a41cb92aa29129f0b4006315a2f37e7fa}{Modes::setOneClickMode}}(isEnabledNow);}
\DoxyCodeLine{207       \textcolor{comment}{// if we turned it on then switch to that mode}}
\DoxyCodeLine{208       \textcolor{keywordflow}{if} (isEnabledNow) \{}
\DoxyCodeLine{209         \mbox{\hyperlink{classModes_af364c05c80262b084d6150346564721d}{Modes::switchToStartupMode}}();}
\DoxyCodeLine{210       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{211         \mbox{\hyperlink{classModes_a65f088d9076706c4976f7282be323e50}{Modes::setCurMode}}(0);}
\DoxyCodeLine{212       \}}
\DoxyCodeLine{213       \textcolor{comment}{// flash either low white or dim white2 to indicate}}
\DoxyCodeLine{214       \textcolor{comment}{// whether one-\/click mode has been turned on or off}}
\DoxyCodeLine{215       \mbox{\hyperlink{classLeds_a5a3e2c090aa782f4ee7c71c01e8d8a69}{Leds::holdAll}}(isEnabledNow ? \mbox{\hyperlink{ColorConstants_8h_a8d2e758752bf9a63564ec6b2451f1670}{RGB\_WHITE0}} : \mbox{\hyperlink{ColorConstants_8h_a781f96b1d10e6978d3fe096713e97333}{RGB\_WHITE5}});}
\DoxyCodeLine{216     \}}
\DoxyCodeLine{217     \textcolor{keywordflow}{return};}
\DoxyCodeLine{218   \}}
\DoxyCodeLine{219 }
\DoxyCodeLine{220 \textcolor{preprocessor}{\#ifdef VORTEX\_EMBEDDED}}
\DoxyCodeLine{221   \textcolor{comment}{// ESD PROTECTION!}}
\DoxyCodeLine{222   \textcolor{comment}{// Sometimes the chip can be turned on via ESD triggering the wakeup pin}}
\DoxyCodeLine{223   \textcolor{comment}{// if the engine makes it here in less than 2 ticks that means the device turned on}}
\DoxyCodeLine{224   \textcolor{comment}{// via ESD and not via a normal click which cannot possibly be done in less than 1 tick}}
\DoxyCodeLine{225   \textcolor{keywordflow}{if} (now < 2) \{}
\DoxyCodeLine{226     \textcolor{comment}{// if that happens then just gracefully go back to sleep to prevent the chip}}
\DoxyCodeLine{227     \textcolor{comment}{// from turning on randomly in a plastic bag}}
\DoxyCodeLine{228     \textcolor{comment}{// do not save on ESD re-\/sleep}}
\DoxyCodeLine{229     \mbox{\hyperlink{classVortexEngine_a4b2b59ca72d6cd1115ac6cd7c1672e44}{enterSleep}}(\textcolor{keyword}{false});}
\DoxyCodeLine{230     \textcolor{keywordflow}{return};}
\DoxyCodeLine{231   \}}
\DoxyCodeLine{232 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{233 }
\DoxyCodeLine{234   \textcolor{comment}{// finally the user has released the button after initially turning it on,}}
\DoxyCodeLine{235   \textcolor{comment}{// just run the regular main logic of the system}}
\DoxyCodeLine{236 }
\DoxyCodeLine{237   \textcolor{comment}{// re-\/enter keychain mode if it was never disabled}}
\DoxyCodeLine{238   \textcolor{keywordflow}{if} (\mbox{\hyperlink{classModes_a576b63195795fa9c7c41ae9ac65e4334}{Modes::keychainModeEnabled}}() \&\& !\mbox{\hyperlink{classMenus_ab2e22ddc8a2a459c3cb94f45309e6616}{Menus::checkInMenu}}()) \{}
\DoxyCodeLine{239     \textcolor{comment}{// switch to the last mode we were on}}
\DoxyCodeLine{240     \mbox{\hyperlink{classModes_af364c05c80262b084d6150346564721d}{Modes::switchToStartupMode}}();}
\DoxyCodeLine{241     \textcolor{comment}{// enter keychain mode menu}}
\DoxyCodeLine{242     \mbox{\hyperlink{classMenus_a218d5257123a6399289d0cba0988cbd3}{Menus::openMenu}}(\mbox{\hyperlink{Menus_8h_ab27add79b32f886cb88e53dca2e1ce0faf9f5342b97da62aed25334234bccdcd3}{MENU\_GLOBAL\_BRIGHTNESS}}, \textcolor{keyword}{true});}
\DoxyCodeLine{243   \}}
\DoxyCodeLine{244 }
\DoxyCodeLine{245   \textcolor{comment}{// first look for the force-\/sleep and instant on/off toggle}}
\DoxyCodeLine{246   \textcolor{keyword}{const} uint32\_t holdTime = \mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_a2e0dae337117cd85f69c8346d369504a}{holdDuration}}();}
\DoxyCodeLine{247   \textcolor{comment}{// force-\/sleep check takes precedence above all, but it does not run when keychain mode is enabled}}
\DoxyCodeLine{248   \textcolor{keywordflow}{if} (\mbox{\hyperlink{classVortexEngine_a139832c7933b4a4e0419787c56b4ef2b}{m\_forceSleepEnabled}} \&\& holdTime >= \mbox{\hyperlink{Timings_8h_a73665265b394d9de459568f68f0bd8e2}{FORCE\_SLEEP\_THRESHOLD\_TICKS}}) \{}
\DoxyCodeLine{249     \textcolor{comment}{// as long as they hold down past this threshold just turn off}}
\DoxyCodeLine{250     \textcolor{keywordflow}{if} (\mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_a6ed2a4b4e00facf5c42a11ecd1f4e1c7}{isPressed}}()) \{}
\DoxyCodeLine{251       \mbox{\hyperlink{classLeds_a6f7c9cdfab407455403167fd8f2c350a}{Leds::clearAll}}();}
\DoxyCodeLine{252       \textcolor{keywordflow}{return};}
\DoxyCodeLine{253     \}}
\DoxyCodeLine{254     \textcolor{comment}{// but as soon as they actually release put the device to sleep}}
\DoxyCodeLine{255     \textcolor{keywordflow}{if} (\mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_a277f0bc922ec0cb3a20b6aaf43e9b94e}{onRelease}}()) \{}
\DoxyCodeLine{256       \textcolor{comment}{// do not save on force sleep}}
\DoxyCodeLine{257       \mbox{\hyperlink{classVortexEngine_a4b2b59ca72d6cd1115ac6cd7c1672e44}{enterSleep}}(\textcolor{keyword}{false});}
\DoxyCodeLine{258     \}}
\DoxyCodeLine{259     \textcolor{keywordflow}{return};}
\DoxyCodeLine{260   \}}
\DoxyCodeLine{261 }
\DoxyCodeLine{262   \textcolor{comment}{// run the menus to see if they are open and need to do anything}}
\DoxyCodeLine{263   \textcolor{keywordflow}{if} (\mbox{\hyperlink{classMenus_ab7628e9188ad88b34acfb72f498b5a7c}{Menus::run}}()) \{}
\DoxyCodeLine{264     \textcolor{comment}{// if they return true that means the menus are open and rendering so just return}}
\DoxyCodeLine{265     \textcolor{keywordflow}{return};}
\DoxyCodeLine{266   \}}
\DoxyCodeLine{267 }
\DoxyCodeLine{268   \textcolor{comment}{// if the user releases the button after the sleep threshold and}}
\DoxyCodeLine{269   \textcolor{comment}{// we're still in menu state not open, then we can go to sleep}}
\DoxyCodeLine{270   \textcolor{keywordflow}{if} (\mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_a277f0bc922ec0cb3a20b6aaf43e9b94e}{onRelease}}() \&\& holdTime >= \mbox{\hyperlink{Timings_8h_a8251f10e3a780d9a23fe43f5d25fac56}{SLEEP\_ENTER\_THRESHOLD\_TICKS}}) \{}
\DoxyCodeLine{271     \textcolor{comment}{// enter sleep mode}}
\DoxyCodeLine{272     \mbox{\hyperlink{classVortexEngine_a4b2b59ca72d6cd1115ac6cd7c1672e44}{enterSleep}}();}
\DoxyCodeLine{273     \textcolor{keywordflow}{return};}
\DoxyCodeLine{274   \}}
\DoxyCodeLine{275 }
\DoxyCodeLine{276   \textcolor{comment}{// if the button is just held beyond the sleep threshold then}}
\DoxyCodeLine{277   \textcolor{keywordflow}{if} (\mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_a6ed2a4b4e00facf5c42a11ecd1f4e1c7}{isPressed}}() \&\& holdTime >= \mbox{\hyperlink{Timings_8h_a8251f10e3a780d9a23fe43f5d25fac56}{SLEEP\_ENTER\_THRESHOLD\_TICKS}}) \{}
\DoxyCodeLine{278     \textcolor{comment}{// clear all the leds for a short moment}}
\DoxyCodeLine{279     \mbox{\hyperlink{classLeds_a6f7c9cdfab407455403167fd8f2c350a}{Leds::clearAll}}();}
\DoxyCodeLine{280     \textcolor{comment}{// then oncethe user holds past the sleep window threshold open up the menus}}
\DoxyCodeLine{281     \textcolor{keywordflow}{if} (holdTime >= (\mbox{\hyperlink{Timings_8h_a8251f10e3a780d9a23fe43f5d25fac56}{SLEEP\_ENTER\_THRESHOLD\_TICKS}} + \mbox{\hyperlink{Timings_8h_acf7ff5e81eb3275c7011d0504c067e1d}{SLEEP\_WINDOW\_THRESHOLD\_TICKS}})) \{}
\DoxyCodeLine{282       \textcolor{comment}{// open the menu selection area}}
\DoxyCodeLine{283       \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}Entering ring fill..."{}});}
\DoxyCodeLine{284       \mbox{\hyperlink{classMenus_a1f8dacb375bd4d1ec18da2ed5a3e8cb3}{Menus::openMenuSelection}}();}
\DoxyCodeLine{285     \}}
\DoxyCodeLine{286     \textcolor{comment}{// don't play the modes because the user is going into menus}}
\DoxyCodeLine{287     \textcolor{keywordflow}{return};}
\DoxyCodeLine{288   \}}
\DoxyCodeLine{289 }
\DoxyCodeLine{290   \textcolor{comment}{// lastly check if we are locking the device, which can only happen if they click the}}
\DoxyCodeLine{291   \textcolor{comment}{// button 5 times quickly when the device was off, so 4 times in the first x ticks because}}
\DoxyCodeLine{292   \textcolor{comment}{// the first click was used to wake the device and isn't counted in the consecutive clicks}}
\DoxyCodeLine{293   \textcolor{keywordflow}{if} (now < (\mbox{\hyperlink{Timings_8h_ae76f1a92ba0f97abcfa5007efb8acb35}{CONSECUTIVE\_WINDOW\_TICKS}} * \mbox{\hyperlink{VortexConfig_8h_a2f5ef442fae5fcc560776b23fa1ccef3}{DEVICE\_LOCK\_CLICKS}}) \&\& \mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_af08888134084d0640b6a891bdb755f14}{onConsecutivePresses}}(\mbox{\hyperlink{VortexConfig_8h_a2f5ef442fae5fcc560776b23fa1ccef3}{DEVICE\_LOCK\_CLICKS}} -\/ 1)) \{}
\DoxyCodeLine{294 \textcolor{preprocessor}{\#ifdef VORTEX\_LIB}}
\DoxyCodeLine{295     \textcolor{keywordflow}{if} (!Vortex::lockEnabled()) \{}
\DoxyCodeLine{296       \textcolor{keywordflow}{return};}
\DoxyCodeLine{297     \}}
\DoxyCodeLine{298 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{299     \textcolor{comment}{// lock and just go to sleep, don't need to reset consecutive press counter here}}
\DoxyCodeLine{300     \mbox{\hyperlink{classModes_a1ae90978222b457a941f0cbf7dd9b46b}{Modes::setLocked}}(\textcolor{keyword}{true});}
\DoxyCodeLine{301     \mbox{\hyperlink{classVortexEngine_a4b2b59ca72d6cd1115ac6cd7c1672e44}{enterSleep}}();}
\DoxyCodeLine{302     \textcolor{keywordflow}{return};}
\DoxyCodeLine{303   \}}
\DoxyCodeLine{304 }
\DoxyCodeLine{305   \textcolor{comment}{// toggle auto cycle mode with many clicks at main modes}}
\DoxyCodeLine{306   \textcolor{keywordflow}{if} (\mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_af08888134084d0640b6a891bdb755f14}{onConsecutivePresses}}(\mbox{\hyperlink{VortexConfig_8h_a99fb9bcab397455dbf9c0e2aa904d2d9}{AUTO\_CYCLE\_MODES\_CLICKS}})) \{}
\DoxyCodeLine{307     \mbox{\hyperlink{classVortexEngine_ae6812312d6c117bf487ea7d2754f8063}{m\_autoCycle}} = !\mbox{\hyperlink{classVortexEngine_ae6812312d6c117bf487ea7d2754f8063}{m\_autoCycle}};}
\DoxyCodeLine{308     \mbox{\hyperlink{classLeds_a5a3e2c090aa782f4ee7c71c01e8d8a69}{Leds::holdAll}}(\mbox{\hyperlink{classVortexEngine_ae6812312d6c117bf487ea7d2754f8063}{m\_autoCycle}} ? \mbox{\hyperlink{ColorConstants_8h_ab6c97468034c02fe204fd37036d9be15}{RGB\_GREEN}} : \mbox{\hyperlink{ColorConstants_8h_aa039288455af8a3812a35aa1e7b903e4}{RGB\_RED}});}
\DoxyCodeLine{309   \}}
\DoxyCodeLine{310 }
\DoxyCodeLine{311   \textcolor{comment}{// if auto cycle is enabled and the last switch was more than the delay ago}}
\DoxyCodeLine{312   \textcolor{keywordflow}{if} (\mbox{\hyperlink{classVortexEngine_ae6812312d6c117bf487ea7d2754f8063}{m\_autoCycle}} \&\& (\mbox{\hyperlink{classModes_ac20debd8d48811c3e669cc601996925d}{Modes::lastSwitchTime}}() + \mbox{\hyperlink{VortexConfig_8h_ae54a4f60fb47ad89ca3c3aafc3e77860}{AUTO\_RANDOM\_DELAY}} < now)) \{}
\DoxyCodeLine{313     \textcolor{comment}{// then switch to the next mode automatically}}
\DoxyCodeLine{314     \mbox{\hyperlink{classModes_a70c51e7490681e5ee6a6e6d8084b8fc4}{Modes::nextModeSkipEmpty}}();}
\DoxyCodeLine{315   \}}
\DoxyCodeLine{316 }
\DoxyCodeLine{317   \textcolor{comment}{// otherwise just play the modes}}
\DoxyCodeLine{318   \mbox{\hyperlink{classModes_a9e98b568fcd3d00b7c3f0705b5120925}{Modes::play}}();}
\DoxyCodeLine{319 \}}

\end{DoxyCode}


References AUTO\+\_\+\+CYCLE\+\_\+\+MODES\+\_\+\+CLICKS, AUTO\+\_\+\+RANDOM\+\_\+\+DELAY, Menus\+::check\+In\+Menu(), Leds\+::clear\+All(), CONSECUTIVE\+\_\+\+WINDOW\+\_\+\+TICKS, DEBUG\+\_\+\+LOG, DEVICE\+\_\+\+LOCK\+\_\+\+CLICKS, enable\+MOSFET(), enter\+Sleep(), FORCE\+\_\+\+SLEEP\+\_\+\+THRESHOLD\+\_\+\+TICKS, g\+\_\+p\+Button, Time\+::get\+Curtime(), Leds\+::hold\+All(), Button\+::hold\+Duration(), Button\+::is\+Pressed(), Modes\+::keychain\+Mode\+Enabled(), Modes\+::last\+Switch\+Time(), Modes\+::locked(), m\+\_\+auto\+Cycle, m\+\_\+force\+Sleep\+Enabled, MENU\+\_\+\+GLOBAL\+\_\+\+BRIGHTNESS, Modes\+::next\+Mode\+Skip\+Empty(), Button\+::on\+Consecutive\+Presses(), ONE\+\_\+\+CLICK\+\_\+\+THRESHOLD\+\_\+\+TICKS, Modes\+::one\+Click\+Mode\+Enabled(), Button\+::on\+Release(), Menus\+::open\+Menu(), Menus\+::open\+Menu\+Selection(), Modes\+::play(), Button\+::release\+Count(), RGB\+\_\+\+GREEN, RGB\+\_\+\+RED, RGB\+\_\+\+WHITE0, RGB\+\_\+\+WHITE5, Menus\+::run(), Modes\+::set\+Cur\+Mode(), Modes\+::set\+Locked(), Modes\+::set\+One\+Click\+Mode(), SLEEP\+\_\+\+ENTER\+\_\+\+THRESHOLD\+\_\+\+TICKS, SLEEP\+\_\+\+WINDOW\+\_\+\+THRESHOLD\+\_\+\+TICKS, and Modes\+::switch\+To\+Startup\+Mode().



Referenced by tick().

\mbox{\Hypertarget{classVortexEngine_a194a57be4545c9e7d0ceb0df6cf3d7e8}\label{classVortexEngine_a194a57be4545c9e7d0ceb0df6cf3d7e8}} 
\index{VortexEngine@{VortexEngine}!serializeVersion@{serializeVersion}}
\index{serializeVersion@{serializeVersion}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{serializeVersion()}{serializeVersion()}}
{\footnotesize\ttfamily bool Vortex\+Engine\+::serialize\+Version (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classByteStream}{Byte\+Stream}} \&}]{stream }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 321 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{322 \{}
\DoxyCodeLine{323   \textcolor{comment}{// serialize the vortex version}}
\DoxyCodeLine{324   \textcolor{keywordflow}{return} stream.\mbox{\hyperlink{classByteStream_a16016f5dc73e0d8b639f6bdbea252d4b}{serialize}}((uint8\_t)\mbox{\hyperlink{VortexConfig_8h_ad51691e0bf3c0a33a9b4929507a7d4d8}{VORTEX\_VERSION\_MAJOR}}) \&\&}
\DoxyCodeLine{325          stream.\mbox{\hyperlink{classByteStream_a16016f5dc73e0d8b639f6bdbea252d4b}{serialize}}((uint8\_t)\mbox{\hyperlink{VortexConfig_8h_a5192bd4a7eea3a54e5b00405185d9d4d}{VORTEX\_VERSION\_MINOR}});}
\DoxyCodeLine{326 \}}

\end{DoxyCode}


References Byte\+Stream\+::serialize(), VORTEX\+\_\+\+VERSION\+\_\+\+MAJOR, and VORTEX\+\_\+\+VERSION\+\_\+\+MINOR.



Referenced by Modes\+::save\+To\+Buffer(), and Mode\+::save\+To\+Buffer().

\mbox{\Hypertarget{classVortexEngine_ad824edd37d12e0ba7efafd8cd844e1b7}\label{classVortexEngine_ad824edd37d12e0ba7efafd8cd844e1b7}} 
\index{VortexEngine@{VortexEngine}!tick@{tick}}
\index{tick@{tick}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{tick()}{tick()}}
{\footnotesize\ttfamily void Vortex\+Engine\+::tick (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 127 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{128 \{}
\DoxyCodeLine{129 \textcolor{preprocessor}{\#ifdef VORTEX\_LIB}}
\DoxyCodeLine{130   \textcolor{keywordflow}{if} (\mbox{\hyperlink{classVortexEngine_a68bdf824c4c7b2303a1b1a37da67f496}{m\_sleeping}}) \{}
\DoxyCodeLine{131     \textcolor{comment}{// update the buttons to check for wake}}
\DoxyCodeLine{132     \mbox{\hyperlink{classButtons_a4e775beebe1f2c6dce04c82ed14741cb}{Buttons::update}}();}
\DoxyCodeLine{133     \textcolor{comment}{// several fast clicks will unlock the device}}
\DoxyCodeLine{134     \textcolor{keywordflow}{if} (\mbox{\hyperlink{classModes_abe515fae0059b1213ba544b613051e97}{Modes::locked}}() \&\& \mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_af08888134084d0640b6a891bdb755f14}{onConsecutivePresses}}(\mbox{\hyperlink{VortexConfig_8h_a2f5ef442fae5fcc560776b23fa1ccef3}{DEVICE\_LOCK\_CLICKS}} -\/ 1)) \{}
\DoxyCodeLine{135       \textcolor{comment}{// turn off the lock flag and save it to disk}}
\DoxyCodeLine{136       \mbox{\hyperlink{classModes_a1ae90978222b457a941f0cbf7dd9b46b}{Modes::setLocked}}(\textcolor{keyword}{false});}
\DoxyCodeLine{137     \}}
\DoxyCodeLine{138     \textcolor{comment}{// check for any kind of press to wakeup}}
\DoxyCodeLine{139     \textcolor{keywordflow}{if} (\mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_a0a4fbfb56d10cb2c6e69a35eb62b7292}{check}}() || \mbox{\hyperlink{Button_8h_a0f2e1bfb2e10150496ad7fb75420713b}{g\_pButton}}-\/>\mbox{\hyperlink{classButton_a277f0bc922ec0cb3a20b6aaf43e9b94e}{onRelease}}() || !Vortex::sleepEnabled()) \{}
\DoxyCodeLine{140       \mbox{\hyperlink{classVortexEngine_a32e7878bb1f4e4c4d141e849ff7808fb}{wakeup}}();}
\DoxyCodeLine{141     \}}
\DoxyCodeLine{142     \textcolor{keywordflow}{return};}
\DoxyCodeLine{143   \}}
\DoxyCodeLine{144 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{145   \textcolor{comment}{// handle any fatal errors that may have occurred}}
\DoxyCodeLine{146   \textcolor{comment}{// but only if the error blinker is enabled}}
\DoxyCodeLine{147 \textcolor{preprocessor}{\#if VORTEX\_ERROR\_BLINK == 1}}
\DoxyCodeLine{148   \textcolor{keywordflow}{if} (getError() != \mbox{\hyperlink{ErrorBlinker_8h_abe670cc5ceed3fad3be682fc0c1bb62e}{ERROR\_NONE}}) \{}
\DoxyCodeLine{149     \textcolor{comment}{// just blink the error and don't run anything}}
\DoxyCodeLine{150     blinkError();}
\DoxyCodeLine{151     \textcolor{keywordflow}{return};}
\DoxyCodeLine{152   \}}
\DoxyCodeLine{153 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{154 }
\DoxyCodeLine{155   \textcolor{comment}{// tick the current time counter forward}}
\DoxyCodeLine{156   \mbox{\hyperlink{classTime_a823b10e685d34b667e16e36fea96e150}{Time::tickClock}}();}
\DoxyCodeLine{157 }
\DoxyCodeLine{158   \textcolor{comment}{// poll the button(s) and update the button object states}}
\DoxyCodeLine{159   \mbox{\hyperlink{classButtons_a4e775beebe1f2c6dce04c82ed14741cb}{Buttons::update}}();}
\DoxyCodeLine{160 }
\DoxyCodeLine{161   \textcolor{comment}{// run the main logic for the engine}}
\DoxyCodeLine{162   \mbox{\hyperlink{classVortexEngine_ad8500f86579f3e6d9f887698e181b4d2}{runMainLogic}}();}
\DoxyCodeLine{163 }
\DoxyCodeLine{164   \textcolor{comment}{// update the leds}}
\DoxyCodeLine{165   \mbox{\hyperlink{classLeds_a7b552b40079b1179fd47f7aeea88878d}{Leds::update}}();}
\DoxyCodeLine{166 \}}

\end{DoxyCode}


References Button\+::check(), DEVICE\+\_\+\+LOCK\+\_\+\+CLICKS, ERROR\+\_\+\+NONE, g\+\_\+p\+Button, Modes\+::locked(), m\+\_\+sleeping, Button\+::on\+Consecutive\+Presses(), Button\+::on\+Release(), run\+Main\+Logic(), Modes\+::set\+Locked(), Time\+::tick\+Clock(), Buttons\+::update(), Leds\+::update(), and wakeup().



Referenced by ISR().

\mbox{\Hypertarget{classVortexEngine_af00c20421c2dc846493a17109c462bb4}\label{classVortexEngine_af00c20421c2dc846493a17109c462bb4}} 
\index{VortexEngine@{VortexEngine}!toggleForceSleep@{toggleForceSleep}}
\index{toggleForceSleep@{toggleForceSleep}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{toggleForceSleep()}{toggleForceSleep()}}
{\footnotesize\ttfamily static void Vortex\+Engine\+::toggle\+Force\+Sleep (\begin{DoxyParamCaption}\item[{bool}]{enabled }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [static]}}



Definition at line 48 of file Vortex\+Engine.\+h.


\begin{DoxyCode}{0}
\DoxyCodeLine{48 \{ \mbox{\hyperlink{classVortexEngine_a139832c7933b4a4e0419787c56b4ef2b}{m\_forceSleepEnabled}} = enabled; \}}

\end{DoxyCode}


References m\+\_\+force\+Sleep\+Enabled.



Referenced by Color\+Select\+::init(), Global\+Brightness\+::init(), Color\+Select\+::$\sim$\+Color\+Select(), and Global\+Brightness\+::$\sim$\+Global\+Brightness().

\mbox{\Hypertarget{classVortexEngine_a32e7878bb1f4e4c4d141e849ff7808fb}\label{classVortexEngine_a32e7878bb1f4e4c4d141e849ff7808fb}} 
\index{VortexEngine@{VortexEngine}!wakeup@{wakeup}}
\index{wakeup@{wakeup}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{wakeup()}{wakeup()}}
{\footnotesize\ttfamily void Vortex\+Engine\+::wakeup (\begin{DoxyParamCaption}\item[{bool}]{reset = {\ttfamily true} }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 397 of file Vortex\+Engine.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{398 \{}
\DoxyCodeLine{399   \mbox{\hyperlink{Log_8h_a5d2f30bd1cbcf49f829a7e8eb6173c06}{DEBUG\_LOG}}(\textcolor{stringliteral}{"{}Waking up"{}});}
\DoxyCodeLine{400 \textcolor{preprocessor}{\#ifdef VORTEX\_EMBEDDED}}
\DoxyCodeLine{401   \textcolor{comment}{// turn the LED mosfet back on}}
\DoxyCodeLine{402   \mbox{\hyperlink{classVortexEngine_ad1132c049a66099d3a35e6850db6d629}{enableMOSFET}}(\textcolor{keyword}{true});}
\DoxyCodeLine{403   \textcolor{keywordflow}{if} (reset) \{}
\DoxyCodeLine{404     \textcolor{comment}{// just reset}}
\DoxyCodeLine{405     \_PROTECTED\_WRITE(RSTCTRL.SWRR, 1);}
\DoxyCodeLine{406   \}}
\DoxyCodeLine{407 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{408   \textcolor{comment}{// need to fake the reset in vortexlib, lol this works I guess}}
\DoxyCodeLine{409   \mbox{\hyperlink{classVortexEngine_a68bdf824c4c7b2303a1b1a37da67f496}{m\_sleeping}} = \textcolor{keyword}{false};}
\DoxyCodeLine{410   \textcolor{keywordflow}{if} (reset) \{}
\DoxyCodeLine{411     \mbox{\hyperlink{classVortexEngine_ae80679477cd0c0f726e610b26fc1a6db}{cleanup}}();}
\DoxyCodeLine{412     \mbox{\hyperlink{classVortexEngine_a7d0883a55ea519ac58a24637c0cc38d2}{init}}();}
\DoxyCodeLine{413   \}}
\DoxyCodeLine{414 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{415 \}}

\end{DoxyCode}


References cleanup(), DEBUG\+\_\+\+LOG, enable\+MOSFET(), init(), and m\+\_\+sleeping.



Referenced by ISR(), and tick().



\doxysubsection{Member Data Documentation}
\mbox{\Hypertarget{classVortexEngine_ae6812312d6c117bf487ea7d2754f8063}\label{classVortexEngine_ae6812312d6c117bf487ea7d2754f8063}} 
\index{VortexEngine@{VortexEngine}!m\_autoCycle@{m\_autoCycle}}
\index{m\_autoCycle@{m\_autoCycle}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{m\_autoCycle}{m\_autoCycle}}
{\footnotesize\ttfamily bool Vortex\+Engine\+::m\+\_\+auto\+Cycle = false\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}



Definition at line 63 of file Vortex\+Engine.\+h.



Referenced by run\+Main\+Logic().

\mbox{\Hypertarget{classVortexEngine_a139832c7933b4a4e0419787c56b4ef2b}\label{classVortexEngine_a139832c7933b4a4e0419787c56b4ef2b}} 
\index{VortexEngine@{VortexEngine}!m\_forceSleepEnabled@{m\_forceSleepEnabled}}
\index{m\_forceSleepEnabled@{m\_forceSleepEnabled}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{m\_forceSleepEnabled}{m\_forceSleepEnabled}}
{\footnotesize\ttfamily bool Vortex\+Engine\+::m\+\_\+force\+Sleep\+Enabled = true\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}



Definition at line 60 of file Vortex\+Engine.\+h.



Referenced by run\+Main\+Logic(), and toggle\+Force\+Sleep().

\mbox{\Hypertarget{classVortexEngine_a68bdf824c4c7b2303a1b1a37da67f496}\label{classVortexEngine_a68bdf824c4c7b2303a1b1a37da67f496}} 
\index{VortexEngine@{VortexEngine}!m\_sleeping@{m\_sleeping}}
\index{m\_sleeping@{m\_sleeping}!VortexEngine@{VortexEngine}}
\doxysubsubsection{\texorpdfstring{m\_sleeping}{m\_sleeping}}
{\footnotesize\ttfamily volatile bool Vortex\+Engine\+::m\+\_\+sleeping = false\hspace{0.3cm}{\ttfamily [static]}, {\ttfamily [private]}}



Definition at line 59 of file Vortex\+Engine.\+h.



Referenced by enter\+Sleep(), init(), tick(), and wakeup().



The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
Vortex\+Engine/src/\mbox{\hyperlink{VortexEngine_8h}{Vortex\+Engine.\+h}}\item 
Vortex\+Engine/src/\mbox{\hyperlink{VortexEngine_8cpp}{Vortex\+Engine.\+cpp}}\end{DoxyCompactItemize}
